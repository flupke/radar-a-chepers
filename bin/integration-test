#!/usr/bin/env bash
set -euo pipefail

FLY_APP=rshep

# Fetch Google OAuth secrets from Fly if not already set
if [ -z "${GOOGLE_CLIENT_ID:-}" ] || [ -z "${GOOGLE_CLIENT_SECRET:-}" ]; then
  echo "==> Fetching Google OAuth secrets from Fly ($FLY_APP)..."
  export GOOGLE_CLIENT_ID=$(fly ssh console --app "$FLY_APP" -C "printenv GOOGLE_CLIENT_ID" -q)
  export GOOGLE_CLIENT_SECRET=$(fly ssh console --app "$FLY_APP" -C "printenv GOOGLE_CLIENT_SECRET" -q)
fi

# Trap EXIT to kill background processes
cleanup() { kill 0 2>/dev/null; }
trap cleanup EXIT

# Start the web app
cd web
mix ecto.create --quiet 2>/dev/null || true
mix ecto.migrate --quiet
mix phx.server &
cd ..

# Create infractions dir and start the uploader
mkdir -p /tmp/infractions
cd uploader
RUST_LOG=info cargo run --bin uploader -- \
  --test-mode \
  --api-endpoint=http://localhost:4000 \
  --api-key=radar-dev-key \
  --infractions-dir=/tmp/infractions
